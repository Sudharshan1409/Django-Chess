{% extends "base.html" %}
{% load extra_polls %}
{% load static %}
{% block style %}
    <style>
        .chess-board { border-spacing: 0; border-collapse: collapse;  }
        .chess-board th + th { border-bottom: 1px solid #000; }
        .chess-board td:first-child { border-left: 1px solid #000; }
        .chess-board tr:first-child { border-top: 1px solid #000; }
        .chess-board td:last-child { border-right: 1px solid #000; }
        .chess-board tr:last-child td { border-bottom: 1px solid; }
        .chess-board th:empty { border: none; }
        .chess-board td { width: 10vmin; height: 10vmin; text-align: center; line-height: 0; }
        .chess-board td img {
            max-width:100%;
            max-height:100%;
            position: relative;
        }
        .chess-board td span {
            width: 3vmin; 
            height: 3vmin;
            background-color: rgb(33, 48, 255, 0.7);
            border-radius: 40%;
            display: inline-block;
            position: center;
        }
        .chess-board td { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .chess-board .light { background: #eee; }
        .chess-board .dark { background: rgb(122, 119, 119); }
        .chess-board .selected { background: rgb(176, 152, 63); }
        .chess-board .danger_black { background: rgb(180,100,101); }
        .chess-board .danger_white { background: rgb(238,160,161); }
        .chess-board .danger { background: rgb(255,0,0,0.8); }

        {% if user.is_authenticated %}
            .chess-board td:hover { background-color: rgb(66, 132, 161); }
        {% endif %}

        .online {
            color: green;
        }

        .status_div {
            width: 80vmin;
            display: block;
            height: 1vmin;
            margin-left: auto;
            margin-right: auto;
        }

        .status_div .connection_status {
            float: left;
            width: 40vmin;
            font-size: 2vmin;
        }

        .status_div .turn {
            float: right;
            width: 40vmin;
            font-size: 2vmin;
        }

        .offline {
            color: red;
        }

        @media only screen and (orientation: portrait) {
            .chess-board td { width: 12vmin; height: 12vmin; text-align: center; line-height: 0; }

            .status_div {
                width: 90vmin;
                display: block;
                height: 1vmin;
                margin-left: auto;
                margin-right: auto;
            }
    
            .status_div .connection_status {
                float: left;
                width: 45vmin;
                font-size: 3vmin;
            }
    
            .status_div .turn {
                float: right;
                width: 45vmin;
                font-size: 3vmin;
            }
        }

    </style>
{% endblock %}

{% block content %}
    <div id="status_div" class="status_div">
         <div id="connection_status" class="connection_status" align="left"></div>
         <div id="turn" class="turn" align="right"></div>
    </div>
    <br>
    <table id="chess-board" class="chess-board" align="center">
        
    </table>
    <br>
    <center><a onclick="toggle_board_func();"><button>Toggle</button></a></center>
{% endblock %}

{% block script %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js" integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
    const rows = ['8', '7', '6', '5', '4', '3', '2', '1']
    const rows_reverse = ['1', '2', '3', '4', '5', '6', '7', '8']
    const columns = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h']
    const columns_reverse = ['h', 'g', 'f', 'e', 'd', 'c', 'b', 'a']
    const pon_details = JSON.parse("{{ game_details.pons_details|convertJSON }}")
    const game_id = {{ game_details.pk }}
    const player_details = {
        'white': {},
        'black': {},
        'current': {},
        'opponent': {},
    }
    player_details.white.pk = "{{ game_details.player_white.pk }}"
    player_details.black.pk = "{{ game_details.player_black.pk }}"
    player_details.white.uname = "{{ game_details.player_white }}"
    player_details.black.uname = "{{ game_details.player_black }}"
    player_details.current.uname = "{{ user }}"
    player_details.current.pk = "{{ user.pk }}"

    {% if user == game_details.player_white %}
        player_details.opponent.uname = player_details.black.uname
        player_details.opponent.pk = player_details.black.pk
    {% else %}
        player_details.opponent.uname = player_details.white.uname
        player_details.opponent.pk = player_details.white.pk
    {% endif %}

    
    let toggle_board;
    let turn = "{{ game_details.turn }}"
    let king_positions = JSON.parse("{{ game_details.king_positions|convertJSON }}")
    let moves = JSON.parse("{{ game_details.moves }}")
    let moved_checks = JSON.parse("{{ game_details.moved_checks|convertJSON }}")
    let pons_position = JSON.parse("{{ game_details.pons_position|convertJSON }}")
    let pon_clicked = null
    let color = 'light'
    let movable_positions = []
    let previous_clicked_pon = null
    let check = false

    var window_location = window.location
    var wsprotocol = 'ws://'

    if(window_location == 'https') {
        wsprotocol = 'wss://'
    }

    if (player_details.white.pk == player_details.current.pk)
        toggle_board = false
    else
        toggle_board = true
            

    var endpoint = wsprotocol + window_location.host + '/ws/game/' + game_id + '/'

    const chatSocket = new ReconnectingWebSocket(endpoint);

    console.log("player white:", "{{ game_details.player_white }}")
    console.log("player black:", "{{ game_details.player_black }}")
    console.log("current user:", "{{ user }}")
    console.log("turn:", "{{ game_details.turn }}")
    console.log("toggle:", toggle_board)
    console.log('player details:', player_details)

    const choose_turn = () => {
        turn_element = document.getElementById('turn')
        if(player_details.current.pk == player_details[turn].pk) 
            turn_element.innerHTML = `Turn: <b class='online'>${ player_details[turn].uname }</b>`
        else
            turn_element.innerHTML = `Turn: <b class='offline'>${ player_details[turn].uname }</b>`
    }
    
    const toggle_color = () => {
        if(color == 'light') {
            color = 'dark'
        }
        else {
            color = 'light'
        }
    }

    const toggle_turn = () => {
        if(turn == 'white') {
            turn = 'black'
        }
        else {
            turn = 'white'
        }
        choose_turn()
    }

    const toggle_board_func = () => {
        toggle_board = !toggle_board
        loadboard()
    }

    const move_up = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        if(parseInt(ival) == 8) {
            return []
        }
        for(let i=parseInt(ival)+1; i<parseInt(ival)+max_place+1; i++) {
            let element = document.getElementById(`${jval}${i}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(i == 8) {
                break
            }
        }
        return moves
    }

    move_left_top = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        iindex = rows.indexOf(ival)
        jindex = columns.indexOf(jval)
        if(jindex==0) {
            return []
        }
        if(iindex==0) {
            return []
        }
        for(let i=iindex-1, j=jindex-1; i>iindex-max_place-1, j>jindex-max_place-1; i--,j--) {
            let element = document.getElementById(`${columns[j]}${rows[i]}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(i==0 || j==0) {
                break
            }
        }
        return moves
    }

    move_left_bottom = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        iindex = rows.indexOf(ival)
        jindex = columns.indexOf(jval)
        if(jindex==0) {
            return []
        }
        if(iindex==7) {
            return []
        }
        for(let i=iindex+1, j=jindex-1; i<iindex+max_place+1, j>jindex-max_place-1; i++,j--) {
            let element = document.getElementById(`${columns[j]}${rows[i]}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(i==7 || j==0) {
                break
            }
        }
        return moves
    }

    move_left = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        jindex = columns.indexOf(jval)
        if(jindex==0) {
            return []
        }
        for(let j=jindex-1; j>jindex-max_place-1; j--) {
            let element = document.getElementById(`${columns[j]}${ival}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(j==0) {
                break
            }
        }
        return moves
    }

    move_right_top = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        iindex = rows.indexOf(ival)
        jindex = columns.indexOf(jval)
        if(jindex==7) {
            return []
        }
        if(iindex==0) {
            return []
        }
        for(let i=iindex-1, j=jindex+1; i>iindex-max_place-1, j<jindex+max_place+1; i--,j++) {
            let element = document.getElementById(`${columns[j]}${rows[i]}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(i==0 || j==7) {
                break
            }
        }
        return moves
    }
    
    move_right = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        jindex = columns.indexOf(jval)
        if(jindex==7) {
            return []
        }
        for(let j=jindex+1; j<jindex+max_place+1; j++) {
            let element = document.getElementById(`${columns[j]}${ival}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(j==7) {
                break
            }
        }
        return moves
    }

    move_right_bottom = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        iindex = rows.indexOf(ival)
        jindex = columns.indexOf(jval)
        if(jindex==7) {
            return []
        }
        if(iindex==7) {
            return []
        }
        for(let i=iindex+1, j=jindex+1; i<iindex+max_place+1, j<jindex+max_place+1; i++,j++) {
            let element = document.getElementById(`${columns[j]}${rows[i]}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if(i==7 || j==7) {
                break
            }
        }
        return moves
    }

    const move_down = (max_place=8, ignore_opponent_pon=false, ival, jval, pon_color) => {
        let moves = []
        if(parseInt(ival) == 1) {
            return []
        }
        for(let i=parseInt(ival)-1; i>parseInt(ival)-max_place-1; i--) {
            let element = document.getElementById(`${jval}${i}`)
            if (element.innerHTML){
                if (ignore_opponent_pon) {
                    break;
                }
                else {
                    if (element.getAttribute('poncolor') == pon_color) {
                        break;
                    }
                    else {
                        moves.push(element)
                        break;
                    }
                }
            }
            else {
                moves.push(element)
            }
            if (i == 1) {
                break
            }
        }
        return moves
    }

    const calculate_move = (pon_clicked) => {
        let can_move = []
        let element = null
        if (pon_clicked.getAttribute('ponvalue') == 'soldier') {
            if (pon_clicked.getAttribute('poncolor') == 'white') {
                if (pon_clicked.getAttribute('ival') == 2) {
                    can_move = move_up(2, true, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))
                }
                else {
                    can_move = move_up(1, true, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))
                }
                left_diagonal = move_left_top(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))[0]
                right_diagonal = move_right_top(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))[0]
                if (left_diagonal && left_diagonal.getAttribute('poncolor') && left_diagonal.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(left_diagonal)
                }
                if (right_diagonal && right_diagonal.getAttribute('poncolor') && right_diagonal.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(right_diagonal)
                }
            }
            else {
                if (pon_clicked.getAttribute('ival') == 7) {
                    can_move = move_down(2, true, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))
                }
                else {
                    can_move = move_down(1, true, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))
                }
                left_diagonal = move_left_bottom(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))[0]
                right_diagonal = move_right_bottom(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor'))[0]
                if (left_diagonal && left_diagonal.getAttribute('poncolor') && left_diagonal.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(left_diagonal)
                }
                if (right_diagonal && right_diagonal.getAttribute('poncolor') && right_diagonal.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(right_diagonal)
                }
            }
        }
        else if (pon_clicked.getAttribute('ponvalue') == 'knight') {
            let iindex = rows.indexOf(pon_clicked.getAttribute('ival'))
            let jindex = columns.indexOf(pon_clicked.getAttribute('jval'))
            if (iindex+2 < 8 && jindex+1 < 8) {
                element = document.getElementById(`${columns[jindex+1]}${rows[iindex+2]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex+2 < 8 && jindex-1 > -1) {
                element = document.getElementById(`${columns[jindex-1]}${rows[iindex+2]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex-2 > -1 && jindex+1 < 8) {
                element = document.getElementById(`${columns[jindex+1]}${rows[iindex-2]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex-2 > -1 && jindex-1 > -1) {
                element = document.getElementById(`${columns[jindex-1]}${rows[iindex-2]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex-1 > -1 && jindex-2 > -1) {
                element = document.getElementById(`${columns[jindex-2]}${rows[iindex-1]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex+1 < 8 && jindex-2 > -1) {
                element = document.getElementById(`${columns[jindex-2]}${rows[iindex+1]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex-1 > -1 && jindex+2 < 8) {
                element = document.getElementById(`${columns[jindex+2]}${rows[iindex-1]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
            if (iindex+1 < 8 && jindex+2 < 8) {
                element = document.getElementById(`${columns[jindex+2]}${rows[iindex+1]}`)
                if(!element.getAttribute('poncolor') || element.getAttribute('poncolor') != pon_clicked.getAttribute('poncolor')) {
                    can_move.push(element)
                }
            }
        }
        else if (pon_clicked.getAttribute('ponvalue') == 'queen') {
            can_move = can_move.concat(move_up(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_down(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left_top(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right_top(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left_bottom(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right_bottom(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
        }
        else if (pon_clicked.getAttribute('ponvalue') == 'bishop') {
            can_move = can_move.concat(move_left_top(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right_top(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left_bottom(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right_bottom(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
        }
        else if (pon_clicked.getAttribute('ponvalue') == 'rook') {
            can_move = can_move.concat(move_up(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_down(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right(8, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
        }
        else if (pon_clicked.getAttribute('ponvalue') == 'king') {
            can_move = can_move.concat(move_up(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_down(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left_top(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right_top(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_left_bottom(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
            can_move = can_move.concat(move_right_bottom(1, false, pon_clicked.getAttribute('ival'), pon_clicked.getAttribute('jval'), pon_clicked.getAttribute('poncolor')))
        }
        return can_move
    }

    const board_clicked = (position) => {
        if(player_details[turn].pk == player_details.current.pk) {
            let get_selected = document.getElementsByClassName('selected')
            for(let element of get_selected) {
                element.className = element.getAttribute('color')
            }
            pon_clicked = document.getElementById(position)
            for(const pos of movable_positions) {
                if(pos.getAttribute('poncolor')) {
                    pos.className = pos.getAttribute('color')
                }
                else {
                    pos.innerHTML = ''
                }
            }
            if(pon_clicked.getAttribute('poncolor') == turn) {
                pon_clicked.className = "selected"
                movable_positions = calculate_move(pon_clicked)
                for (const move of movable_positions) {
                    if(move.getAttribute('poncolor')) {
                        if(move.className == 'dark') {
                            move.className = 'danger_black'
                        }
                        else {
                            move.className = 'danger_white'
                        }
                    }
                    else {
                        move.innerHTML = '<span></span>'
                    }
                }
                previous_clicked_pon = pon_clicked
            }
            else {
                if (previous_clicked_pon && previous_clicked_pon.getAttribute('poncolor')) {
                    let moved_position = document.getElementById(position)
                    let poncolor = previous_clicked_pon.getAttribute('poncolor')
                    let ponvalue = previous_clicked_pon.getAttribute('ponvalue')
                    if (movable_positions.includes(moved_position)) {
                        let move = {
                            before: previous_clicked_pon.id,
                            after: moved_position.id,
                            before_ponvalue: ponvalue,
                            after_ponvalue: ponvalue
                        }
                        if(ponvalue == 'soldier') {
                            if(moved_position.getAttribute('ival') == '1' || moved_position.getAttribute('ival') == '8') {
                                previous_clicked_pon.setAttribute('ponvalue', 'queen')
                                move.after_ponvalue = 'queen'
                            }
                        }
                        else if(ponvalue == 'king') {
                            king_positions[poncolor] = moved_position.id
                            moved_checks[poncolor][ponvalue] = true
                        }
                        else if(ponvalue == 'rook') {
                            if (!moved_checks[poncolor][ponvalue][previous_clicked_pon.getAttribute('jval')])
                                moved_checks[poncolor][ponvalue][previous_clicked_pon.getAttribute('jval')] = true
                        }
                        moves.push(move)
                        pons_position[moved_position.id] = pons_position[previous_clicked_pon.id]
                        pons_position[previous_clicked_pon.id] = ''
                        let message = {
                            source: previous_clicked_pon.id,
                            destination: moved_position.id,
                            poncolor: poncolor,
                            ponvalue: ponvalue,
                            king_positions: king_positions,
                            moved_checks: moved_checks,
                            pons_position: pons_position,
                            moves: moves,
                        }
                        chatSocket.send(JSON.stringify({
                            'message': JSON.stringify(message),
                            'type': 'move',
                            'user': player_details.current.pk
                        }));
                        //condition here for soldier reaching top
                    }
                }
            }
        }
    }

    const loadboard = () => {
        table = document.getElementById('chess-board')
        let table_content = "<tbody>"
        if(toggle_board) {
            for(const i of rows_reverse) {
                table_content += "<tr>"
                for (const j of columns_reverse) {
                    table_content += `<td onclick="board_clicked('${j}${i}')" class="${color}" ival="${i}" jval="${j}" id="${j}${i}" color="${color}"></td>`
                    toggle_color(color)
                }
                toggle_color(color)
                table_content += "</tr>"
            }
        }
        else {
            for(const i of rows) {
                table_content += "<tr>"
                for (const j of columns) {
                    table_content += `<td onclick="board_clicked('${j}${i}')" class="${color}" ival="${i}" jval="${j}" id="${j}${i}" color="${color}"></td>`
                    toggle_color(color)
                }
                toggle_color(color)
                table_content += "</tr>"
            }
        }
        table_content += "</tbody>"
        table.innerHTML = table_content
        loadpons()
    }
    
    const loadpons = () => {
        for(const [position, pon] of Object.entries(pons_position)) {
            if (pon) {
                let pon_split = pon.split(',')
                let element = document.getElementById(position)
                element.innerHTML = `<img src="/static/images/pons/${pon_split[0]}_${pon_split[1]}.png" alt="">`
                element.setAttribute('ponvalue', pon_split[1])
                element.setAttribute('poncolor', pon_split[0])
            }
        }
    }

    const get_toggle_turn = () => {
        if(turn == 'white') {
            return 'black'
        }
        return 'white'
    }
    
    const check_for_check_mate = (opp_turn) => {
        let element;
        let pon_split;
        let result;
        movable_locations = []
        for(const [position, pon] of Object.entries(pons_position)) {
            if (pon.includes(opp_turn)) {
                element = document.getElementById(position)
                movable_locations = calculate_move(element)
                console.log(movable_locations)
                for(location of movable_locations) {
                    let pons_position_copy = JSON.parse(JSON.stringify(pons_position));
                    pons_position_copy[location.id] = pons_position_copy[position]
                    pons_position_copy[position] = ''
                    pon_split = pon.split(',')
                    console.log(location, movable_locations)
                    if (!location.getAttribute('poncolor')) {
                        element.removeAttribute('poncolor')
                        element.removeAttribute('ponvalue')
                        element.innerHTML = ''
                        location.setAttribute('poncolor', pon_split[0])
                        location.setAttribute('ponvalue', pon_split[1])
                        location.innerHTML = `<img src="/static/images/pons/${pon_split[0]}_${pon_split[1]}.png" alt="">`

                        result = check_for_check(opp_turn)

                        location.removeAttribute('poncolor')
                        location.removeAttribute('ponvalue')
                        location.innerHTML = ''
                        element.setAttribute('poncolor', pon_split[0])
                        element.setAttribute('ponvalue', pon_split[1])
                        element.innerHTML = `<img src="/static/images/pons/${pon_split[0]}_${pon_split[1]}.png" alt="">`
                        if(!result)
                            return false
                    }
                    else {
                        element.removeAttribute('poncolor')
                        element.removeAttribute('ponvalue')
                        element.innerHTML = ''
                        let location_poncolor = location.getAttribute('poncolor')
                        let location_ponvalue = location.getAttribute('ponvalue')
                        location.setAttribute('poncolor', pon_split[0])
                        location.setAttribute('ponvalue', pon_split[1])
                        location.innerHTML = `<img src="/static/images/pons/${pon_split[0]}_${pon_split[1]}.png" alt="">`

                        result = check_for_check(opp_turn)

                        element.setAttribute('poncolor', location_poncolor)
                        element.setAttribute('ponvalue', location_ponvalue)
                        location.innerHTML = `<img src="/static/images/pons/${location_poncolor}_${location_ponvalue}.png" alt="">`
                        element.setAttribute('poncolor', pon_split[0])
                        element.setAttribute('ponvalue', pon_split[1])
                        element.innerHTML = `<img src="/static/images/pons/${pon_split[0]}_${pon_split[1]}.png" alt="">`
                        if(!result)
                            return false
                    }
                }
            }
        }
        return true
    }
    
    const check_for_check = (opp_turn) => {
        let element;
        danger_locations = []
        for(const [position, pon] of Object.entries(pons_position)) {
            if (pon.includes(turn)) {
                element = document.getElementById(position)
                danger_locations = danger_locations.concat(calculate_move(element))
            }
        }
        element = document.getElementById(king_positions[opp_turn])
        console.log('element:', element.id)
        for(let pos of danger_locations) {
            console.log('locations:', pos.id)
        }
        if (danger_locations.includes(element)) {
            check = true
            element.className = 'danger'
            return true
        }
        return false
    }
    
    const new_move = (data) => {
        let response = JSON.parse(data.message)
        let source_position = document.getElementById(response.source)
        let destination_position = document.getElementById(response.destination)
        source_position.removeAttribute('poncolor')
        source_position.removeAttribute('ponvalue')
        source_position.innerHTML = ''
        moves = response.moves
        destination_position.setAttribute('poncolor', response.poncolor)
        destination_position.setAttribute('ponvalue', moves[moves.length-1].after_ponvalue)
        destination_position.innerHTML = `<img src="/static/images/pons/${response.poncolor}_${moves[moves.length-1].after_ponvalue}.png" alt="">`
        king_positions = response.king_positions
        moved_checks = response.moved_checks
        pons_position = response.pons_position
        opp_turn = get_toggle_turn()
        if(check_for_check(opp_turn)) {
            if(check_for_check_mate(opp_turn)) {
                console.log('check mate')
            }
        }
        toggle_turn()
    }
    
    chatSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type == 'move') {
            new_move(data)
        }
    };

    chatSocket.onclose = (event) => {
        console.error('websocket closed unexpectedly');
        connection_status = document.getElementById('connection_status')
        connection_status.innerHTML = "Connection Status: <b class='offline'>OFFLINE</b>"
    };

    chatSocket.onopen = (event) => {
        connection_status = document.getElementById('connection_status')
        connection_status.innerHTML = "Connection Status: <b class='online'>ONLINE</b>"
    };

    chatSocket.onerror = (event) => {
        
    }
    
    window.onload = function() {
        choose_turn()
        loadboard()
    };
        
    </script>
{% endblock %}